name: Convert Swagger to OpenAPI

# This workflow demonstrates how to use the prepare/swagger action to convert
# Swagger 2.0 specs to OpenAPI 3.x format. It can run on pull requests or pushes
# to automatically convert and commit the updated spec.

on:
  pull_request:
    paths:
      - 'swagger.json'
      - 'swagger.yaml'
  push:
    branches:
      - main
    paths:
      - 'swagger.json'
      - 'swagger.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  convert-swagger:
    runs-on: ubuntu-latest

    steps:
      # IMPORTANT: Always checkout the repository first!
      # Without this step, the action cannot access your spec files.
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use the pull request head ref for PRs, otherwise use the default branch
          ref: ${{ github.head_ref || github.ref }}
          # Required for committing changes back to the repository
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert Swagger to OpenAPI
        uses: stainless-api/upload-openapi-spec-action/prepare/swagger@v1
        with:
          # Path to your Swagger 2.0 spec file
          input_path: ./swagger.json

          # Path where the converted OpenAPI 3.x spec will be written
          output_path: ./openapi.json

          # Fix up small errors in the source definition
          patch: false

          # Resolve external references
          resolve: true

          # Target OpenAPI version: '3.0' or '3.1'
          target_version: '3.0'

          # Whether to commit the converted file
          commit: true

          # Commit message (only used if commit is true)
          commit_message: 'chore: convert Swagger 2.0 to OpenAPI 3.x'

          # GitHub token for committing (defaults to GITHUB_TOKEN)
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Use the converted spec in subsequent steps
      - name: Display conversion result
        run: |
          echo "Conversion complete!"
          echo "Output file: ${{ steps.convert.outputs.output_path }}"
